---
{
  "title": "201.4: Stake Delegation",
  "slt": ["201.4"],
  "type": "Lesson",
  "description": "Learn to register stake address and delegate stake to a stake pool.",
  "videoURL": "",
  "lastEdited": "2024-02-15",
  "author": "Write: Leon Lai"
}
---

## Why delegate stake?

When you hold ADA in a wallet, you also hold a stake in the Cardano network, proportional to the amount. Stake could be delegated to a stake pool, which is a group of people who combined their resources to increase the chance of being chosen to mint a new block. In return, the participators will share the rewards from the process.

## Lesson Overview 

In this lesson, you will learn how to get the reward address from the users and register their reward address for staking. The user will be able to stake their ADA to a stake pool through your application. 

## Part-1: Connect Wallet and Get Wallet Information

To start with, you have to allow the user to connect their wallet. You can use the `CardanoWallet` component or the `useWallet()` React hook learned in the previous lessons:

```typescript
import { useWallet, CardanoWallet, MeshProvider } from "@meshsdk/react";

export const Staking = () => {
  const { connected, wallet } = useWallet();

  return (
    <MeshProvider>
      <div>
        <CardanoWallet />
      </div>
    </MeshProvider>
  );
};
```

After the user have connected their wallet, you can get the wallet information such as the reward address:

```typescript
import { useWallet } from "@meshsdk/react";
import { useEffect, useState } from "react";

export default function StakingPage() {
  const { wallet, connected } = useWallet();
  const [rewardAddress, setRewardAddress] = useState("");

  useEffect(() => {
    if (connected) {
      wallet?.getRewardAddresses().then((addresses) => {
        console.log("reward addresses: ", addresses);
        setRewardAddress(addresses[0]);
      });
    }
  }, [connected]);

  return (
    <div className="p-3">
      {connected ? <p>Connected</p> : <p>Not Connected</p>}
      {rewardAddress ? (
        <p>Reward Address: {rewardAddress}</p>
      ) : (
        <p>Fetching Reward Address...</p>
      )}
    </div>
  );
}
```

In the tsx above, you used connected Browser Wallet instance to get the associated reward addresses. The `getRewardAddresses()` method returns an array of reward addresses. You can then use the first address in the array in this case for the following steps.

## Part-2: Delegate the Stake to a Stake Pool

Before the user can delegate their stake, their address must be registered. You can use the `registerStakeAddress()` method to register the reward address. Then, you can use the `delegateStake()` method to delegate the stake to a stake pool:

```typescript 
import { Transaction } from "@meshsdk/core";
import { useWallet } from "@meshsdk/react";
import { useEffect, useState } from "react";

export default function StakingPage() {
  const { wallet, connected } = useWallet();
  const [rewardAddress, setRewardAddress] = useState("");

  useEffect(() => {
    if (connected) {
      wallet?.getRewardAddresses().then((addresses) => {
        console.log("reward addresses: ", addresses);
        setRewardAddress(addresses[0]);
      });
    }
  }, [connected]);

  const delegateStake = async () => {
    const poolId = "pool1mhww3q6d7qssj5j2add05r7cyr7znyswe2g6vd23anpx5sh6z8d"; // Gimba Labs stake pool
    try {
      const tx = new Transaction({ initiator: wallet });
      tx.registerStake(rewardAddress);
      tx.delegateStake(rewardAddress, poolId);
      const unsignedTx = await tx.build();
      const signedTx = await wallet.signTx(unsignedTx);
      const txHash = await wallet.submitTx(signedTx);
      return txHash;
    } catch (error) {
      console.log("Staking error: ", error);
      return "error";
    }
  };

  return (
    <div className="p-3">
      {connected ? (
        <>
          <p>Connected</p>
          {rewardAddress ? (
            <p>Reward Address: {rewardAddress}</p>
          ) : (
            <p>Fetching Reward Address...</p>
          )}
          <button
            onClick={delegateStake}
            className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
          >
            Delegate Stake
          </button>
        </>
      ) : (
        <>
          <p>Wallet Not Connected</p>
          <p>Connect your wallet before delegating stake</p>
        </>
      )}
    </div>
  );
}
```

In the tsx above, you build a transaction that first used the `registerStakeAddress()` method to register the reward address of the user. Then, the `delegateStake()` method is used to delegate the stake to a stake pool. The Gimba Labs pool is used in this example. You could use any pre-prod stake pool for testing.

You can now run `npm run dev` and go to http://localhost:3000 to see the result. After you connect your wallet, you should see the reward address and be able to delegate your stake to a stake pool by clicking the button.

## Part-3: Further Integration

Besides, connecting the wallet and delegating stake, you can also utilized blockchain providers such as [Maestro](https://www.gomaestro.org/) and [BlockFrost](https://blockfrost.io/) to get detailed information about the user's wallet and the stake pool for further integration. For example, we could check if the reward address is registered and if the stake is delegated to a specific pool:

```typescript
import { Configuration, MaestroClient } from '@maestro-org/typescript-sdk'

const maestroClient = new MaestroClient(
    new Configuration({
        apiKey: 'your-api-key',
        network: 'Preprod'
    })
)

const checkIfStaked = async (rewardAddress: string) => {
    const info = await maestroClient.accounts.accountInfo(rewardAddress)
    const { registered, delegated_pool } = info.data.data
    return { registered, staked: delegated_pool === 'your_pool_id' }
}
```

You can then use the information for a better implementation:

```typescript
const delegateStake = async () => {
    const poolId = "pool1mhww3q6d7qssj5j2add05r7cyr7znyswe2g6vd23anpx5sh6z8d"; // Gimba Labs stake pool
    if (await checkIfStaked(rewardAddress)) {
        console.log('Already staked')
        // Do something else to appreciate the support
    } else {
        try {
            const tx = new Transaction({ initiator: wallet });
            if (!registered) {
                tx.registerStake(rewardAddress);
            }
            tx.delegateStake(rewardAddress, poolId);
            const unsignedTx = await tx.build();
            const signedTx = await wallet.signTx(unsignedTx);
            const txHash = await wallet.submitTx(signedTx);
            return txHash;
        } catch (error) {
            console.log("Staking error: ", error);
            return "error";
        }
    }
};
```

## Conclusion

In this lesson, you now understand how to get the reward address of the user and delegate stake to a stake pool. This could have many useful implications, such as building your Cardano community and allowing users to stake in to your ideas.

Feel free to make modifications and create something different while applying the same principles from code example above to practice your skills as a developer.
